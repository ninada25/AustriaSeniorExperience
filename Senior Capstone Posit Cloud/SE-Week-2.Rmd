---
title: "SE Week 2 Work"
output: html_document
date: "2024-01-10"
---
```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE, warning = FALSE)
```

```{r}
library(tidyverse)
library(readr)
library(knitr)
library(ggplot2)
library(dplyr)
library(maps)
library(Lock5Data)
library(gridExtra)
```

```{r, echo=FALSE}
#setwd("/cloud/project/data")
happy <- read_csv("hapiscore2018.csv") # only want to look at happiness scores for 2018 since the other dataset I will work with contains data from 2018

data("AllCountries")

### DATA CLEANING - World Happiness Report 2018 ### 

summary(happy)
happy[sapply(happy, is.character)] <- lapply(happy[sapply(happy, is.character)], as.factor) # convert all character variables to factor
happy$`Perceptions of corruption` <- as.numeric(as.character(happy$`Perceptions of corruption`)) # convert perceptions of corruption to numeric
glimpse(happy)
colnames(happy) <- gsub(" ", "_", colnames(happy)) # replace all spaces in column names with underscores
n_distinct(happy$Country_or_region) # 156 different countries or regions

### DATA CLEANING - AllCountries (data for each variable were collected for 2018 (or most recently available year) ###

summary(AllCountries)
n_distinct(AllCountries$Country) # 217 different countries in this dataset, I will only look at the places that also have a happiness score in the other dataset

### CREATING A MERGED DATASET 

# Merge two datasets
countries_with_happy <- merge(happy, AllCountries, by.x = "Country_or_region", by.y = "Country") 

# Call column '2018' 'Happiness_score'
colnames(countries_with_happy)[colnames(countries_with_happy) == "Score"] <- "Happiness_score" 

summary(countries_with_happy)
glimpse(countries_with_happy)
n_distinct(countries_with_happy$Country_or_region) # 137 countries in final dataset

# Selecting a subset of the data
countries_with_happy <- countries_with_happy[, c("Happiness_score", "Country_or_region", "GDP", "Military", "Health", "Internet", "Unemployment")]
```

Last week, I created graphs and tables summarizing my data.

# Graphs and Tables Summarizing Data

```{r}
# Histogram of happiness scores 
ggplot(data=countries_with_happy, aes(x=Happiness_score)) + 
  geom_histogram(fill="purple", color="white") + 
  ggtitle("Distribution of Happiness Scores") +
  xlab("Happiness Score (0-10)") + 
  ylab("Frequency")
```

The histogram shows us the distribution of happiness scores. More than 12 countries have a score of around 4.4, and many countries have scores between 5 and 6.5. A couple of countries have scores close to 3, while a few have scores of 8 or above. (Note: Happiness score is the national average response to the question of life evaluations asking "Please imagine a ladder, with steps numbered from 0 at the bottom to 10 at the top. The top of the ladder represents the best possible life for you and the bottom of the ladder represents the worst possible life for you. On which step of the ladder would you say you personally feel you stand at this time?" This measure is also referred to as Cantril life ladder.)

```{r}
# Scatterplot of happiness score VS GDP per capita
ggplot(data=countries_with_happy, aes(x=GDP, y=Happiness_score)) + 
  geom_point() +
  ggtitle("GDP VS Happiness Score") + 
  ylab("Happiness Score (0-10)") + 
  xlab("GDP per capita") 
```

Overall, there is an upward trend, indicating that countries or regions with higher GDP tend to, on average, have higher happiness scores, and there seems to be some curvature here. There is a good amount of variability in happiness scores for countries with very low GDPs. For countries with GDPs close to 0 (i.e. in the low hundreds of US$), happiness scores range from below 3 to above 6. Note also that 4 countries with GDPs of above \$60,000 have happiness scores below 7.

For the data points that have GDP per capita very close to 0, this implies either an extremely low or non-exist GDP (total economic output) or a very large population relative to the economic output. Burundi has a GDP per capita of $275.

```{r}
library(corrplot)

# Correlation plot for numerical variables in the dataset:
Corr <- cor(select_if(countries_with_happy, is.numeric), use="complete.obs")
corrplot(Corr)
```

Happiness score seems to have a fairly high positive correlation with GDP which is consistent with what I found in my scatterplot above. Happiness score also has fairly high positive correlations with percentage of government expenditures directed towards healthcare and percentage of the population with access to the internet. Happiness score has a weak negative correlation with unemployment, but it also has a weak negative correlation with percentage of government expenditures directed toward the military, which is interesting and might be something worth looking into.

```{r}
# Sorting the Data by GDP and Selecting the 10 Lowest GDPs
lowest_gdp_data <- countries_with_happy[order(countries_with_happy$GDP), ][1:10,]

# Creating a Horizontal Bar Chart of Happiness Scores for the 10 Countries with the Lowest GDPs
ggplot(lowest_gdp_data, aes(x = Happiness_score, y = reorder(Country_or_region, GDP), fill = GDP)) +
  scale_fill_gradient(low = "lightblue", high = "dodgerblue") + 
  geom_bar(stat = "identity") +
  labs(title = "Happiness Scores for the 10 Countries/Regions with the Lowest GDPs", x = "Happiness Score (0-10)", y = "Country or Region") +
  xlim(0,10) + # setting scale for x axis
  theme_minimal() +
  theme(axis.text = element_text(size = 10)) +
  geom_label(mapping = aes(label = Happiness_score))
```

```{r}
# Sorting the Data by GDP and Selecting the 10 Highest GDPs
highest_gdp_data <- countries_with_happy[order(countries_with_happy$GDP, decreasing = TRUE), ][1:10,]

# Creating a Horizontal Bar Chart of Happiness Scores for the 10 Countries with the Lowest GDPs
ggplot(highest_gdp_data, aes(x = Happiness_score, y = reorder(Country_or_region, GDP), fill = GDP)) +
  scale_fill_gradient(low = "lightblue", high = "dodgerblue") + 
  geom_bar(stat = "identity") +
  labs(title = "Happiness Scores for the 10 Countries/Regions with the Highest GDPs", x = "Happiness Score (0-10)", y = "Country or Region") +
  xlim(0,10) + # setting scale for x axis
  theme_minimal() +
  theme(axis.text = element_text(size = 10)) +
  geom_label(mapping = aes(label = Happiness_score))
```

For the countries or regions with the 10 lowest GDPs in our dataset, happiness scores range from 2.905 to 4.982. Burundi, which has the lowest GDP of all countries and regions in our dataset, has the lowest happiness score of these 10 places. For the countries or regions with the 10 highest GDPs in our dataset, happiness scores range from 6.343 to 7.594. It is interesting that the country with the highest GDP has a lower happiness score than 6 of the countries or regions here.

```{r}
# Scatterplot of happiness score VS military
ggplot(data=countries_with_happy, aes(x=Military, y=Happiness_score)) + 
  geom_point() +
  ggtitle("% Gov Expenditures Directed Toward Military VS Happiness Score") + 
  ylab("Happiness Score (0-10)") + 
  xlab("% Gov Expenditures Directed Toward Military") +
  geom_smooth(method = "lm", se = FALSE)
```

There seems to be a weak, negative linear relationship between percentage of government expenditures directed toward the military and happiness score, which is interesting. With that being said, there is a lot of variability in happiness scores among countries with lower percentages of government expenditures directed toward the military (i.e. less than 10%), with some countries having scores below 3.5 and others having scores above 7.5.

```{r}
# Scatterplot of happiness score VS unemployment
ggplot(data=countries_with_happy, aes(x=Unemployment, y=Happiness_score)) + 
  geom_point() +
  ggtitle("Unemployment VS Happiness Score") + 
  ylab("Happiness Score (0-10)") + 
  xlab("% Labor Force Unemployed") +
  geom_smooth(method = "lm", se = FALSE)
```

There also seems to be a weak, negative linear relationship between percent of the labor force unemployed and happiness score. It is interesting that there is more variability in happiness scores among countries with a smaller percentage of the labor force unemployed.

------------------------------------------------------------------------------------------------------------------------------------------------------------------

# Week 2 Work:

```{r}
ggplot(data=countries_with_happy, aes(x = GDP, y = Happiness_score)) + 
  geom_point() +
  stat_smooth(method="lm", se=FALSE) + 
  ggtitle("Happines Score VS GDP") + 
  xlab("GDP") + ylab("Happiness Score (0-10)") 

ggplot(data=countries_with_happy, aes(x = Internet, y = Happiness_score)) + geom_point() +
  stat_smooth(method="lm", se=FALSE) + 
  ggtitle("Happiness Score VS % Population with Access to Internet") + 
  xlab("% Population with Access to Internet") + ylab("Happiness Score (0-10)") 
```

Fitting a simple linear regression model with GDP as the only explanatory variable to the data, we obtain the following:

```{r}
Happy_M1 <- lm(data=countries_with_happy, Happiness_score~GDP)
summary(Happy_M1)
```

On average, happiness score is expected to increase by about 0.00003799 for each additional $1 in GDP per capita. The low p-value suggests a relationship like this is unlikely to occur by chance. 53.78% of the total variation in happiness score is explained by GDP. 

```{r}
Corr
```

GDP and Internet have a correlation of around 0.713, so we should check to see if SE on GDP increases significantly after adding Internet to our model. 

```{r}
Happy_GDPInternet <- lm(data=countries_with_happy, Happiness_score~GDP+Internet)
summary(Happy_GDPInternet)
```

The SE on GDP increased from 3.043e-06 to 3.575e-06, which is not that much. Thus, it should be fine to include both GDP and Internet in the model. We can interpret this model as follows: on average, happiness score is expected to increase by about 0.00001666 for each additional \$1 in GDP per capital, assuming the percentage of the population with access to the internet remains constant. On average, happiness score is expected to increase by about 0.02285 for each additional percentage of the population with access to the internet, assuming GDP remains constant. 69.85% of the total variation in happiness score is explained by GDP and Internet.

Let us investigate whether there is an interaction between GDP and Internet via scatterplot:

```{r}
# Scatterplot of happiness score VS GDP per capita with color = Internet
ggplot(data=countries_with_happy, aes(x=GDP, y=Happiness_score, color = Internet)) + 
  geom_point() +
  ggtitle("GDP VS Happiness Score") + 
  ylab("Happiness Score (0-10)") + 
  xlab("GDP per capita") 
```

In general, it looks like countries with low percentages of the population with access to the internet have the smallest GDP per capita, which makes sense. There is no super clear difference in the rate of change in happiness score with respect to GDP for different percentages (i.e. 50% vs 75%) of the population with access to internet.

I also created a categorical variable for Internet to further investigate the possibility of an interaction between GDP and Internet:

```{r}
# Creating a categorical variable for Internet:
countries_with_happy$Internet_Categorical <- cut(countries_with_happy$Internet, breaks = c(0, 25, 50, 75, 100), labels = c("0-25", "25-50", "50-75", "75-100"))

# New ggplot
ggplot(data = countries_with_happy, aes(x = GDP, y = Happiness_score, color = Internet_Categorical)) + 
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(group = Internet_Categorical)) +
  ggtitle("GDP VS Happiness Score") + 
  ylab("Happiness Score (0-10)") + 
  xlab("GDP per capita")

```

Again, it just looks to me like the countries with lower percentages of the population with access to the internet have lower GDPs, but it does not necessarily look like there is a need for an interaction term (?). For now, I will opt not to include an interaction between GDP and Internet, which will ultimately complicate model interpretation as well.

We can add Health to the model without interaction. 

```{r}
Happy_M3 <- lm(data=countries_with_happy, Happiness_score~GDP+Internet+Health)
summary(Happy_M3)
```

On average, happiness score is expected to increase by about 0.00001317 for each additional $1 in GDP per capita, assuming the percentage of government expenditures directed towards healthcare and percentage of the population with access to the internet remains constant. The low p-value suggests a relationship like this is unlikely to occur by chance. On average, happiness score is expected to increase by 0.02047 for every 1% increase in population with access to the internet, assuming GDP and percentage of government expenditures directed toward healthcare remain constant. On average, happiness score is expected to increase by 0.04399 for every 1% increase in government expenditures directed towards healthcare, assuming GDP and percentage of the population with access to the internet remain constant. 73.93% of the total variation in happiness score is explained by GDP, Internet, and Health.


Let's try adding in military and unemployment as well:

```{r}
Happy_M4 <- lm(data=countries_with_happy, Happiness_score~GDP+Internet+Health+Military+Unemployment)
summary(Happy_M4)
```

R^2 increased from 0.7393 to 0.7982. 

Now let's check our model assumptions:

```{r}
P1 <- ggplot(data=data.frame(Happy_M4$residuals), aes(y=Happy_M4$residuals, x=Happy_M4$fitted.values)) + geom_point() + ggtitle("Residual Plot") + xlab("Predicted Values") + ylab("Residuals")
P2 <- ggplot(data=data.frame(Happy_M4$residuals), aes(x=Happy_M4$residuals)) + geom_histogram() + ggtitle("Histogram of Residuals") + xlab("Residual")
P3 <- ggplot(data=data.frame(Happy_M4$residuals), aes(sample = scale(Happy_M4$residuals))) + stat_qq() + stat_qq_line() + xlab("Normal Quantiles") + ylab("Residual Quantiles") + ggtitle("QQ Plot")
grid.arrange(P1, P2, P3, ncol=3)
```

We do not see any curvature or funnel shapes in the residual plot, so the linearity and constant variance assumptions seem valid. There is also a bit of left-skewness in our QQ plot, but it doesn’t seem too significant. This may indicate a bit of concern about the normality assumption, although again I don’t think we need to worry too much about it.

With regards to the independence assumption, we must think about whether there were factors in the data collection that would cause some observations to be more highly correlated than others. There's a possibility that countries or regions in the same area / continent are more highly correlated. I might need to think about a model that can account for this -- perhaps I would need a model that accounts for correlation using spatial structure?

In models with multiple explanatory variables, it is helpful to also plot our residuals against the explanatory variables to see whether the model is properly accounting for relationships involving each variable. If we see nonlinear trends, we should consider adding a nonlinear function of that explanatory variable.

```{r}
P4 <- ggplot(data=data.frame(Happy_M4$residuals), aes(y=Happy_M4$residuals, x=Happy_M4$model$GDP)) + geom_point() + ggtitle("Residual by Predictor Plot") + xlab("GDP per capita") + ylab("Residuals")
P5 <- ggplot(data=data.frame(Happy_M4$residuals), aes(y=Happy_M4$residuals, x=Happy_M4$model$Internet)) + geom_point() + ggtitle("Residual by Predictor Plot") + xlab("% Pop With Access to Internet") + ylab("Residuals")
P6 <- ggplot(data=data.frame(Happy_M4$residuals), aes(y=Happy_M4$residuals, x=Happy_M4$model$Health)) + geom_point() + ggtitle("Residual by Predictor Plot") + xlab("% Gov Exp Dir Towards Healthcare") + ylab("Residuals")
P7 <- ggplot(data=data.frame(Happy_M4$residuals), aes(y=Happy_M4$residuals, x=Happy_M4$model$Military)) + geom_point() + ggtitle("Residual by Predictor Plot") + xlab("% Gov Exp Dir Towards Military") + ylab("Residuals")
P8 <- ggplot(data=data.frame(Happy_M4$residuals), aes(y=Happy_M4$residuals, x=Happy_M4$model$Unemployment)) + geom_point() + ggtitle("Residual by Predictor Plot") + xlab("% Labor Force Unemployed") + ylab("Residuals")
grid.arrange(P4, P5, P6, P7, P8, ncol=3)
```

There is some concern about the constant variance assumption, particularly in the plots of residuals against GDP, Military, and Unemployed. It is worth noting that this violation of the constant variance assumption could potentially lead to wider intervals, but the predictions should still be reliable (? I can think more about this). The linearity assumption looks good here; there is not really any curvature in our residual plots. 